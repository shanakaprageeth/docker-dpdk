name: ci

on:
  push:

env:
  UBUNTU_DOC_TEST_TAG: shanakaprageeth/ubuntu24-dpdk:test
  UBUNTU_DOC_LATEST_TAG: shanakaprageeth/ubuntu24-dpdk:latest
  RHEL_DOC_TEST_TAG: shanakaprageeth/rhel8-dpdk:test
  RHEL_DOC_LATEST_TAG: shanakaprageeth/rhel8-dpdk:latest

jobs:
  ubuntu-dpdk:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - 
        name: Checkout repo
        uses: actions/checkout@v4
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          load: true
          context: ./docker-ubuntu-dpdk/
          file: ./docker-ubuntu-dpdk/Dockerfile
          tags: ${{ env.UBUNTU_DOC_TEST_TAG }}
      - 
        name: Test
        run: |
          docker run --rm --privileged  --cap-add=ALL \
          -v /sys/bus/pci/devices:/sys/bus/pci/devices \
          -v /sys/kernel/mm/hugepages:/sys/kernel/mm/hugepages \
          -v /sys/devices/system/node:/sys/devices/system/node \
          -v /dev:/dev \
          -v /home/$USER:/home/$USER \
          --name ubuntu-dpdk ${{ env.UBUNTU_DOC_TEST_TAG }} bash -c "/root/dpdk/usertools/dpdk-hugepages.py -p 2048K --setup 2M --node 0 && cat /proc/meminfo | grep HugePages"

      - 
        name: Build and push
        if: github.ref_name == 'master' || github.ref_name == 'main'
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          push: true
          context: ./docker-ubuntu-dpdk/
          file: ./docker-ubuntu-dpdk/Dockerfile
          tags: ${{ env.UBUNTU_DOC_LATEST_TAG }}
  rhel-dpdk:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - 
        name: Checkout repo
        uses: actions/checkout@v4
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          load: true
          context: ./docker-rhel-dpdk/
          file: ./docker-rhel-dpdk/Dockerfile
          tags: ${{ env.RHEL_DOC_TEST_TAG }}
      - 
        name: Test
        run: |
          docker run --rm --privileged  --cap-add=ALL \
          -v /sys/bus/pci/devices:/sys/bus/pci/devices \
          -v /sys/kernel/mm/hugepages:/sys/kernel/mm/hugepages \
          -v /sys/devices/system/node:/sys/devices/system/node \
          -v /dev:/dev \
          -v /home/$USER:/home/$USER \
          --name ubuntu-dpdk ${{ env.RHEL_DOC_TEST_TAG }} bash -c "/root/dpdk/usertools/dpdk-hugepages.py -p 2048K --setup 2M --node 0 && cat /proc/meminfo | grep HugePages"

      - 
        name: Build and push
        if: github.ref_name == 'master' || github.ref_name == 'main'
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          push: true
          context: ./docker-rhel-dpdk/
          file: ./docker-rhel-dpdk/Dockerfile
          tags: ${{ env.RHEL_DOC_LATEST_TAG }}
